# Stripe Webhook Integration Deployment Guide\n\nThis guide will help you deploy the permanent Stripe webhook integration solution for real-time subscription syncing.\n\n## üéØ Overview\n\nThe webhook integration provides:\n- **Real-time subscription status updates** from Stripe\n- **Automatic trial period calculation** including promo codes\n- **Payment method tracking** (card brand/last 4 digits)\n- **Billing date synchronization**\n- **Comprehensive error logging**\n\n## üìã Prerequisites\n\n1. Stripe account with active products/prices\n2. Supabase database with Baby Steps schema\n3. Deployment platform (Vercel, Netlify, or custom server)\n4. Environment variables configured\n\n## üóÑÔ∏è Step 1: Database Migration\n\nRun the database migration to add Stripe fields:\n\n```bash\n# Apply the migration to your Supabase database\npsql -h your-db-host -U postgres -d postgres < supabase/migrations/add_stripe_fields.sql\n```\n\n**Or via Supabase Dashboard:**\n1. Go to SQL Editor in your Supabase dashboard\n2. Copy the contents of `add_stripe_fields.sql`\n3. Run the script\n\n### New Database Fields Added:\n- `stripe_customer_id` - Links user to Stripe customer\n- `stripe_subscription_id` - Active subscription ID\n- `stripe_subscription_status` - Real-time status from Stripe\n- `stripe_current_period_end` - Next billing date\n- `stripe_trial_end` - Actual trial end from Stripe\n- `payment_method_last4` - Last 4 digits of payment method\n- `payment_method_brand` - Card brand (visa, mastercard, etc.)\n- `promo_code_used` - Applied promo code\n- `promo_months_granted` - Extended trial months\n\n## üöÄ Step 2: Deploy Webhook Endpoint\n\n### Option A: Vercel Deployment\n\n1. **Move the webhook file to the correct location:**\n```bash\nmkdir -p api\nmv src/api/stripe-webhook.js api/stripe-webhook.js\n```\n\n2. **Update the file for Vercel:**\n```javascript\n// api/stripe-webhook.js (Vercel format)\nimport { createClient } from '@supabase/supabase-js';\nconst stripe = require('stripe')(process.env.STRIPE_SECRET_KEY);\n\n// Initialize Supabase with service role\nconst supabase = createClient(\n  process.env.REACT_APP_SUPABASE_URL,\n  process.env.SUPABASE_SERVICE_ROLE_KEY\n);\n\nexport default async function handler(req, res) {\n  // Your webhook code here...\n}\n```\n\n3. **Add environment variables in Vercel:**\n- `STRIPE_SECRET_KEY` - Your Stripe secret key\n- `STRIPE_WEBHOOK_SECRET` - Webhook endpoint secret (get from Stripe dashboard)\n- `REACT_APP_SUPABASE_URL` - Your Supabase URL\n- `SUPABASE_SERVICE_ROLE_KEY` - Service role key (not anon key!)\n\n4. **Deploy:**\n```bash\nvercel deploy\n```\n\n### Option B: Netlify Deployment\n\n1. **Move to Netlify functions directory:**\n```bash\nmkdir -p netlify/functions\nmv src/api/stripe-webhook.js netlify/functions/stripe-webhook.js\n```\n\n2. **Update for Netlify format:**\n```javascript\n// netlify/functions/stripe-webhook.js\nexports.handler = async (event, context) => {\n  // Convert to standard req/res format\n  const req = {\n    method: event.httpMethod,\n    headers: event.headers,\n    body: event.body\n  };\n  \n  const res = {\n    status: (code) => ({ statusCode: code }),\n    json: (body) => ({ body: JSON.stringify(body) })\n  };\n  \n  // Your webhook logic here...\n};\n```\n\n### Option C: Custom Server\n\nFor Express.js server:\n\n```javascript\n// server.js\nconst express = require('express');\nconst app = express();\n\n// Raw body parser for Stripe webhooks\napp.use('/api/stripe-webhook', express.raw({ type: 'application/json' }));\n\napp.post('/api/stripe-webhook', async (req, res) => {\n  // Your webhook logic here...\n});\n\napp.listen(process.env.PORT || 3001);\n```\n\n## ‚öôÔ∏è Step 3: Configure Stripe Webhook\n\n1. **Go to Stripe Dashboard ‚Üí Developers ‚Üí Webhooks**\n\n2. **Click \"Add endpoint\"**\n\n3. **Configure the endpoint:**\n   - **Endpoint URL:** `https://your-domain.com/api/stripe-webhook`\n   - **Description:** \"Baby Steps Subscription Sync\"\n   - **Version:** Latest API version\n\n4. **Select events to listen for:**\n   ```\n   customer.created\n   customer.updated\n   customer.subscription.created\n   customer.subscription.updated\n   customer.subscription.deleted\n   invoice.payment_succeeded\n   invoice.payment_failed\n   checkout.session.completed\n   ```\n\n5. **Save and get the signing secret**\n   - Copy the webhook signing secret\n   - Add it to your environment variables as `STRIPE_WEBHOOK_SECRET`\n\n## üß™ Step 4: Test the Integration\n\n### Test with Stripe CLI (Recommended)\n\n1. **Install Stripe CLI:**\n```bash\nbrew install stripe/stripe-cli/stripe\n# or\ncurl -s https://packages.stripe.com/api/security/keypair/stripe-cli-gpg/public | gpg --dearmor | sudo tee /usr/share/keyrings/stripe.gpg\necho \"deb [signed-by=/usr/share/keyrings/stripe.gpg] https://packages.stripe.com/stripe-cli-debian-local stable main\" | sudo tee -a /etc/apt/sources.list.d/stripe.list\nsudo apt update\nsudo apt install stripe\n```\n\n2. **Login to Stripe:**\n```bash\nstripe login\n```\n\n3. **Forward events to your local server:**\n```bash\nstripe listen --forward-to localhost:3000/api/stripe-webhook\n```\n\n4. **Trigger test events:**\n```bash\n# Test customer creation\nstripe trigger customer.created\n\n# Test subscription creation\nstripe trigger customer.subscription.created\n\n# Test payment success\nstripe trigger invoice.payment_succeeded\n```\n\n### Test with Real Purchases\n\n1. **Use Stripe test mode**\n2. **Create a test purchase** using test card numbers:\n   - Success: `4242424242424242`\n   - Decline: `4000000000000002`\n\n3. **Check webhook logs** in Stripe Dashboard ‚Üí Webhooks ‚Üí Your endpoint\n\n4. **Verify database updates** in Supabase\n\n## üîç Step 5: Verify Database Updates\n\nCheck that webhooks are updating your database:\n\n```sql\n-- Check webhook logs\nSELECT * FROM stripe_webhook_logs \nORDER BY created_at DESC \nLIMIT 10;\n\n-- Check user profiles with Stripe data\nSELECT \n  email,\n  subscription_status,\n  stripe_subscription_status,\n  stripe_current_period_end,\n  payment_method_brand,\n  payment_method_last4\nFROM profiles \nWHERE stripe_customer_id IS NOT NULL;\n\n-- Check for sync issues\nSELECT \n  email,\n  subscription_status as local_status,\n  stripe_subscription_status as stripe_status,\n  CASE \n    WHEN stripe_subscription_status = 'trialing' AND subscription_status != 'trial' THEN 'MISMATCH'\n    WHEN stripe_subscription_status = 'active' AND subscription_status != 'active' THEN 'MISMATCH'\n    WHEN stripe_subscription_status = 'canceled' AND subscription_status != 'free' THEN 'MISMATCH'\n    ELSE 'OK'\n  END as sync_status\nFROM profiles \nWHERE stripe_customer_id IS NOT NULL;\n```\n\n## üì± Step 6: Update Profile Component\n\nThe Profile component will now show enhanced subscription information:\n\n```javascript\n// In Profile.js, the subscription info will now include:\nconst subscriptionInfo = getSubscriptionInfo();\n\n// New fields available:\nsubscriptionInfo.hasStripeData     // true if integrated with Stripe\nsubscriptionInfo.syncStatus        // true if local data matches Stripe\nsubscriptionInfo.details           // Rich details including billing dates\n```\n\n## üéØ Step 7: Monitor and Maintain\n\n### Monitoring\n\n1. **Set up webhook monitoring:**\n   - Check Stripe Dashboard ‚Üí Webhooks regularly\n   - Monitor `stripe_webhook_logs` table for errors\n   - Set up alerts for failed webhooks\n\n2. **Database health checks:**\n```sql\n-- Users with subscription but no Stripe data (may need manual linking)\nSELECT email, subscription_status \nFROM profiles \nWHERE subscription_status IN ('trial', 'active') \nAND stripe_customer_id IS NULL;\n\n-- Recent webhook failures\nSELECT event_type, error, created_at \nFROM stripe_webhook_logs \nWHERE error IS NOT NULL \nAND created_at > NOW() - INTERVAL '24 hours';\n```\n\n### Maintenance Tasks\n\n1. **Weekly:** Check webhook success rate in Stripe Dashboard\n2. **Monthly:** Review sync status between local and Stripe data\n3. **Quarterly:** Update webhook endpoint if API versions change\n\n## üö® Troubleshooting\n\n### Common Issues\n\n**Webhook not receiving events:**\n- Check endpoint URL is publicly accessible\n- Verify HTTPS is enabled\n- Check webhook secret matches\n- Review Stripe Dashboard webhook logs\n\n**Database updates not working:**\n- Verify service role key has correct permissions\n- Check Supabase logs for function execution errors\n- Ensure migration was applied correctly\n\n**Subscription status not updating:**\n- Check if user has `stripe_customer_id` populated\n- Verify webhook is handling the correct events\n- Check `stripe_webhook_logs` for processing errors\n\n### Debug Commands\n\n```bash\n# Test webhook endpoint directly\ncurl -X POST https://your-domain.com/api/stripe-webhook \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"type\": \"test\"}'\n\n# Check Stripe webhook deliveries\nstripe events list --limit 10\n\n# Retry failed webhook\nstripe webhooks deliver <webhook_id> <event_id>\n```\n\n## üìß Step 8: Notify Users of Enhanced Features\n\nOnce deployed, users will see:\n- **Accurate trial periods** for promo codes\n- **Real billing dates** in Profile\n- **Payment method information**\n- **Sync status indicators**\n\nSend an email to existing users:\n\n> **Subject:** Your subscription is now synced with Stripe üéâ\n> \n> We've enhanced your subscription experience! Your trial periods, billing dates, and payment information now sync automatically with Stripe.\n> \n> Check your Profile page to see the updated information.\n\n## ‚úÖ Success Checklist\n\n- [ ] Database migration applied successfully\n- [ ] Webhook endpoint deployed and publicly accessible\n- [ ] Stripe webhook configured with correct events\n- [ ] Environment variables set correctly\n- [ ] Test webhooks working via Stripe CLI\n- [ ] Database updates confirmed\n- [ ] Profile page shows enhanced subscription info\n- [ ] Monitoring and alerts configured\n\n## üîó Resources\n\n- [Stripe Webhook Documentation](https://stripe.com/docs/webhooks)\n- [Stripe CLI Guide](https://stripe.com/docs/stripe-cli)\n- [Supabase Edge Functions](https://supabase.com/docs/guides/functions)\n- [Vercel API Routes](https://vercel.com/docs/concepts/functions/serverless-functions)\n- [Netlify Functions](https://docs.netlify.com/functions/overview/)\n\n---\n\n**üéâ Congratulations!** You now have a fully integrated, real-time subscription system that automatically syncs with Stripe. Users will see accurate subscription information, and you'll have comprehensive logging for debugging and monitoring.\n